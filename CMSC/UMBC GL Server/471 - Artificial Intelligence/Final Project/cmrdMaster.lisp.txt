;;-----------------------------------------
;;Final Project, CMSC, Fall 2009
;;-----------------------------------------


(if (not (find-package :mm-cmrd)) (make-package :mm-cmrd))
(in-package :mm-cmrd)

(use-package :mm)

;(defvar *closed* '())
;;should take in a list of colors and a code length

(defvar *model*  '()
  "List of colors for the current game")

;;Resetting the guesses


(defun init-guess (&optional (colors *colors*) 
                             (code-length *code-length*)
                             &aux reds whites)

  (let ((guess 
         (loop for i from 1 to code-length collect (car colors))))
    (loop while guess
          do (format t "Guessing ~s...~% " guess)
          (multiple-value-setq (reds whites) (mm-score guess))
          
          (if (equalp reds code-length) 
              (progn (format t "Guessed ~s correctly in ~s guesses!~%"
                             guess *guesses*)
                     (return-from init-guess)))
          (loop for i from 1 to reds
                do (setf *model* (append *model* 
                                         (list (car colors)))))
          (if (or (not (equalp code-length (length *model*))) 
                  (null *model*))
              (progn
                (init-guess (cdr colors) code-length)
                (setf guess '())) 
            (progn (setf guess '()) (return-from init-guess))))))


(defun master (&optional (colors *colors*) (code-length *code-length*))
  "Implementing a walkSat variation to solve the 
   Mastermind Game"
  
  ;set our model. narrow our guess to a list of 
  ;all the colors and their quantity

  (set-up)

  (loop for iCounter from 0 to 2000000 do
        (progn
          (cond((equalp reds code-length)
                (format t "master guessed ~s correctly in ~s guesses!~%" 
                        guess *guesses*)
                (return-from master))
               (t (progn 
                   
                  
                    (multiple-value-setq (guess reds)
                                         (mm-solver guess reds)
)))))))

(defun set-up () 
 (setf *model* '())
  (setf *closed* '())
  (setf *ranking* '())
  (setf *guesses* 0)
  (loop for i from 1 to *code-length* do
        (setf *ranking* (append (list '0) *ranking*)))
  (init-guess)
  (setf guess *model*)
  (multiple-value-setq (reds whites)
                       (mm-score guess))
)

(defun mm-solver (guess reds)
  "Will solve problem"
  (setf tempGuess (copy-list guess))
  (setf tGuess (copy-list guess))
  (setf xy 1)
  (setf innerLoop (length guess))
  (setf loopLength (- (length guess) 1))

  (loop for xyz from 0 to (length guess) do
            (loop for zyx from xy to loopLength do
                  ;;if the positions are different check score
                  (format t "Guessing ~s...~%" guess)   
                  (setf tempGuess (copy-list guess))
                  (setf rGuess (swap xyz zyx))

                  (if (and (not (equalp (nth xyz *ranking*) '2))
                           (not (equalp (nth zyx *ranking*) '2))
			   (not (equalp (nth xyz rGuess)
					(nth zyx rGuess))))
                      (progn
			 (format t "Guessing ~s...~%" rGuess)
                        (multiple-value-setq (tRed tWhite)
                                             (mm-score rGuess))
                        
                        (if (equalp tRed (+ reds 2))
                            (progn
                              (setf (nth xyz *ranking*) '2)
                              (setf (nth zyx *ranking*) '2)
                              (setf reds tRed)
                              (setf guess (copy-list rGuess))
                              (return)))
                        
                        (if (> tRed reds)
                            (progn
                              (setf reds tRed)
                              (setf guess (copy-list rGuess)))))))
                  
              (incf xy))
      (values guess reds)
)           

(defun swap (pos1 pos2 &optional (tGuess tempGuess))
  "Swaps two positions in a list"
  (setf tempColor (nth pos1 tempGuess))  
  (setf (nth pos1 tGuess) (nth pos2 tGuess))  
  (setf (nth pos2 tGuess) tempColor)
  (setf tGuess tGuess)
)